!function(){"use strict";angular.module("administration",["ngRoute","ngCookies","infinite-scroll","satellizer","pascalprecht.translate","chart.js","720kb.datepicker","ngFlash"])}(),function(){"use strict";function a(a,b,c,d,e,f){a.profile=null,a.start=function(){a.init(),e.isUserAnAdministrator()?(a.profile=c.getPayload(),a.startRefreshToken()):a.logout()},a.startRefreshToken=function(){if(c.isAuthenticated()){var b=700*(c.getPayload().exp-c.getPayload().iat);setTimeout(function(){return c.isAuthenticated()?a.refreshToken():a.logout(),!0},b)}},a.refreshToken=function(){f.connect(function(b){c.setToken(b,!0),a.startRefreshToken()},function(){a.logout(),alert(d("translate")("alert.disconnect"))})},a.$on("showUser",function(){a.init(),a.showUser=!0}),a.$on("showHistory",function(){a.init(),a.showHistory=!0}),a.$on("showUsers",function(){a.init(),a.showUsers=!0}),a.$on("showHome",function(){a.init(),a.showHome=!0}),a.$on("showCollections",function(){a.init(),a.showCollections=!0}),a.$on("showStats",function(){a.init(),a.showStats=!0}),a.$on("showProducts",function(){a.init(),a.showProducts=!0}),a.$on("showGroups",function(){a.init(),a.showGroups=!0}),a.init=function(){a.showUsers=!1,a.showHistory=!1,a.showUser=!1,a.showHome=!1,a.showCollections=!1,a.showStats=!1,a.selectedUser=null,a.showLeftMenu=!1,a.showProducts=!1,a.showGroups=!1,a.displayLocalAuth=b.auth.displayLocalAuth,a.stats=b.statistics?!0:!1},a.login=function(b,f){c.login({email:b,password:f}).then(function(){return e.isUserAnAdministrator()?(a.profile=c.getPayload(),a.startRefreshToken(),a.closeSignIn(),void 0):(alert(d("translate")("Sorry... You are not an administrator")),void a.logout())})["catch"](function(a){alert(d("translate")("error.login")+a.data)}),b=null,f=null},a.authenticate=function(b){c.authenticate(b).then(function(){return"admin"!==c.getPayload().data.groupname?(alert(d("translate")("Sorry... You are not an administrator")),void a.logout()):void 0})["catch"](function(a){alert(d("translate")("error.login")+a.data)})},a.logout=function(){a.profile=null,c.logout()},a.startSignIn=function(){a.displaySignIn=!0},a.closeSignIn=function(){a.displaySignIn=!1},a.displayLeftMenu=function(){a.showLeftMenu=!a.showLeftMenu},a.start()}angular.module("administration").controller("mainController",["$scope","CONFIG","$auth","$filter","administrationServices","restoUsersAPI",a])}(),function(){"use strict";function a(a,b,c,d){b.baseUrl="",b.authHeader="Authorization",b.loginUrl=d.restoServerUrl+"/api/user/connect",b.signupUrl=d.restoServerUrl+"/user",b.loginRedirect="/ok";var e="oauth2",f=window.location.href.split("#")[0],g=d.auth[e].requiredUrlParams?d.auth[e].requiredUrlParams:[],h=function(){return Math.random().toString(36).substr(2)+Math.random().toString(36).substr(2)};b.oauth2({name:e,url:d.restoServerUrl+"/api/auth/"+e,redirectUri:f,clientId:d.auth[e].clientId,authorizationEndpoint:d.auth[e].authorizeUrl,scope:d.auth[e].scope||null,requiredUrlParams:g,state:h()}),a.useStaticFilesLoader({prefix:"app/i18n/",suffix:".json"}),a.preferredLanguage("en"),c.interceptors.push("myHttpInterceptor")}function b(a){var b=0;return{request:function(a){return $("#spinner").show(),b+=1,a},requestError:function(a){return b-=1,0===b&&$("#spinner").hide(),a},response:function(a){return b-=1,0===b&&$("#spinner").hide(),a},responseError:function(a){return b-=1,0===b&&$("#spinner").hide(),a}}}function c(a,b,c){var d=c.path;c.path=function(e,f){if(f===!1)var g=a.current,h=b.$on("$locationChangeSuccess",function(){a.current=g,h()});return d.apply(c,[e])}}angular.module("administration").config(["$translateProvider","$authProvider","$httpProvider","CONFIG",a]),angular.module("administration").factory("myHttpInterceptor",[b]),angular.module("administration").run(["$route","$rootScope","$location",c])}(),function(){"use strict";angular.module("administration").config(["$routeProvider","CONFIG",function(a,b){b.statistics&&a.when("/stats",{templateUrl:"app/html/stats/stats.html",controller:"StatsController"}),a.when("/home",{templateUrl:"app/html/home/home.html",controller:"HomeController"}).when("/users",{templateUrl:"app/html/users/users.html",controller:"UsersController"}).when("/collections",{templateUrl:"app/html/collections/collections.html",controller:"CollectionsController"}).when("/collections/:collectionname",{templateUrl:"app/html/collection/collection.html",controller:"CollectionController"}).when("/history",{templateUrl:"app/html/history/history.html",controller:"HistoryController"}).when("/groups",{templateUrl:"app/html/groups/groups.html",controller:"GroupsController"}).when("/groups/:groupid",{templateUrl:"app/html/group/group.html",controller:"GroupController"}).when("/users/:userid",{templateUrl:"app/html/user/user.html",controller:"UserController"}).when("/users/:userid/:section",{templateUrl:"app/html/user/user.html",controller:"UserController"}).when("/userCreation",{templateUrl:"app/html/userCreation/userCreation.html",controller:"UserCreationController"}).otherwise({redirectTo:"/home"})}])}(),function(){"use strict";function a(a,b){function c(c,d,e){var f=c.limit,g=c.offset,h=c.ascordesc,i=c.orderby,j=c.email,k=c.method,l=c.service,m=c.maxdate,n=c.mindate,o=c.collection,p=b.restoServerUrl+b.administrationEndpoint;p=p+"/history.json?_offset="+g+"&_limit="+f,j&&(p=p+"&_email="+j),h&&(p=p+"&_ascordesc="+h),i&&(p=p+"&_order="+i),k&&(p=p+"&_method="+k),l&&(p=p+"&_service="+l),m&&(p=p+"&_maxdate="+m),n&&(p=p+"&_mindate="+n),o&&(p=p+"&_collection="+o),a.get(p).success(function(a){a.ErrorMessage?e(a):d(a.history)}).error(function(a){e(a.ErrorMessage?a:"error - get history")})}function d(c,d){a({method:"GET",cache:!0,url:b.restoServerUrl+"/collections.json"}).success(function(a){a.ErrorMessage?d(a):c(a.collections)}).error(function(a){d(a.ErrorMessage?a:"error - get collections failed")})}function e(c,d,e){var f=c.emailorgroup,g=c.collection,h=c.field,i=c.value;a({method:"POST",url:b.restoServerUrl+b.administrationEndpoint+"/collections",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(a){var b=[];for(var c in a)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")},data:{emailorgroup:f,collection:g,field:h,value:i}}).success(function(a){a.ErrorMessage?e(a):d(a)}).error(function(a){e(a.ErrorMessage?a:"error - set collection right")})}function f(c,d){var e=b.restoServerUrl+b.administrationEndpoint+"/stats/collections.json";a({method:"GET",url:e}).success(function(a){a.ErrorMessage?d(a):c(a)}).error(function(a){d(a.ErrorMessage?a:"error - get stats failed")})}function g(c,d,e){a({method:"GET",url:b.restoServerUrl+b.administrationEndpoint+"/users.json",params:{offset:c.offset,limit:c.limit,keywords:c.keyword}}).success(function(a){a.ErrorMessage?e(a):d(a.profiles)}).error(function(a){e(a.ErrorMessage?a:"error - get users")})}function h(c,d){var e=b.restoServerUrl+b.administrationEndpoint+"/stats/users.json";a.get(e).success(function(a){a.ErrorMessage?d(a):c(a)}).error(function(a){d(a.ErrorMessage?a:"error - get stats")})}function i(c,d,e){a({method:"POST",url:b.restoServerUrl+b.administrationEndpoint+"/users",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(a){var b=[];for(var c in a)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")},data:{email:c.email,password:c.password,username:c.username,givename:c.givename,lastname:c.lastname}}).success(function(a){a.ErrorMessage?e(a):d(a)}).error(function(a){e(a)})}function j(c,d,e){a.get(b.restoServerUrl+"/"+b.administrationEndpoint+"/users/"+c+".json").success(function(a){a.ErrorMessage?e(a):d(a.profile)}).error(function(a){e(a.ErrorMessage?a:"error - get user")})}function k(c,d,e){a({method:"PUT",url:b.restoServerUrl+b.administrationEndpoint+"/users/"+c+"/activate"}).success(function(a){a.ErrorMessage?e(a):d(a)}).error(function(a){e(a.ErrorMessage?a:"error - activate user")})}function l(c,d,e){a({method:"PUT",url:b.restoServerUrl+b.administrationEndpoint+"/users/"+c+"/deactivate"}).success(function(a){a.ErrorMessage?e(a):d(a)}).error(function(a){e(a.ErrorMessage?a:"error - deactivate user")})}function m(c,d,e){a({method:"PUT",url:b.restoServerUrl+b.administrationEndpoint+"/users/"+c+"/validate"}).success(function(a){a.ErrorMessage?e(a):d(a)}).error(function(a){e(a.ErrorMessage?a:"error - validate user")})}function n(c,d,e){a({method:"PUT",url:b.restoServerUrl+b.administrationEndpoint+"/users/"+c+"/unvalidate"}).success(function(a){a.ErrorMessage?e(a):d(a)}).error(function(a){e(a.ErrorMessage?a:"error - unvalidate user")})}function o(c,d,e){var f=c.userid,g=c.email,h=c.groupname;a({method:"POST",url:b.restoServerUrl+b.administrationEndpoint+"/users/"+f,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(a){var b=[];for(var c in a)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")},data:{email:g,groupname:h}}).success(function(a){a.ErrorMessage?e(a):d(a)}).error(function(a){e(a.ErrorMessage?a:"error - set group")})}function p(c,d,e){a.get(b.restoServerUrl+b.administrationEndpoint+"/users/"+c+"/signatures").success(function(a){a.ErrorMessage?e(a):d(a.signatures)}).error(function(a){e(a.ErrorMessage?a:"error - get signatures")})}function q(c,d,e){a.get(b.restoServerUrl+b.administrationEndpoint+"/groups/"+c+"/rights.json").success(function(a){a.ErrorMessage?e(a):d(a)}).error(function(a){e(a.ErrorMessage?a:"error - get groups rights")})}function r(c,d,e){var f={};"undefined"!=typeof c.create&&(f.create=c.create),"undefined"!=typeof c.visualize&&(f.visualize=c.visualize),"undefined"!=typeof c.download&&(f.download=c.download),a({method:"PUT",url:b.restoServerUrl+b.administrationEndpoint+"/groups/"+c.groupid+"/rights",dataType:"json",data:{rights:f,target:c.collection_name,targetType:"collection"}}).success(function(a){a.ErrorMessage?e(a):d(a)}).error(function(a){e(a.ErrorMessage?a:"Undefined error")})}function s(c,d,e){a.get(b.restoServerUrl+b.administrationEndpoint+"/users/"+c+"/rights.json").success(function(a){a.ErrorMessage?e(a):d(a.rights)}).error(function(a){e(a.ErrorMessage?a:"error - get rights")})}function t(c,d,e){var f=b.restoServerUrl+b.administrationEndpoint+"/users/"+c.userid+"/rights/"+c.collection;c.featureid&&(f=f+"/"+c.featureid),a({method:"DELETE",url:f,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a){a.ErrorMessage?e(a.ErrorMessage):d(a)}).error(function(a){e(a.ErrorMessage?a:"error - delete right")})}function u(c,d,e){var f=c.userid,g=c.collection,h=c.rights;a({method:"POST",url:b.restoServerUrl+b.administrationEndpoint+"/users/"+f+"/rights/"+g,dataType:"json",data:{rights:h}}).success(function(a){a.ErrorMessage?e(a):d(a)}).error(function(a){e(a.ErrorMessage?a:"Undefined error")})}function v(c,d,e){var f=c.userid,g=c.emailorgroup,h=c.collection,i=c.featureid,j=c.search,k=c.visualize,l=c.download,m=c.canput,n=c.canpost,o=c.candelete,p=c.filters;a({method:"POST",url:b.restoServerUrl+b.administrationEndpoint+"/users/"+f+"/rights",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(a){var b=[];for(var c in a)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")},data:{emailorgroup:g,collection:h,featureid:i,search:j,visualize:k,download:l,canput:m,canpost:n,candelete:o,filters:p}}).success(function(a){a.ErrorMessage?e(a):d(a)}).error(function(a){e(a.ErrorMessage?a:"error - set advanced right")})}function w(c,d,e){c.groups&&c.userid?a({method:"DELETE",url:b.restoServerUrl+b.administrationEndpoint+"/users/"+c.userid+"/groups/"+c.groups}).success(function(a){a.ErrorMessage?e(a):d(a.groups)}).error(function(a){e(a)}):e("groups or userid are missing")}function x(c,d,e){var f=!1,g=b.restoServerUrl+"/"+b.administrationEndpoint+"/users/";c.userid&&(g+=c.userid,f=!1),g+="/groups",a({method:"GET",cache:f,url:g,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a){a.ErrorMessage?e(a):d(a.groups)}).error(function(a){e(a)})}function y(c,d,e){var f=c.groupid,g=b.restoServerUrl+"/"+b.administrationEndpoint+"/groups/"+f+"/users";a({method:"GET",url:g,params:{limit:c.limit,offset:c.offset}}).success(function(a){a.ErrorMessage?e(a):d(a.users)}).error(function(a){e(a)})}function z(c,d,e){a({method:"POST",url:b.restoServerUrl+b.administrationEndpoint+"/groups",data:{groupid:c}}).success(function(a){a.ErrorMessage?e(a):d(a.groups)}).error(function(a){e(a)})}function A(c,d,e){c.groups&&c.userid?a({method:"PUT",url:b.restoServerUrl+b.administrationEndpoint+"/users/"+c.userid+"/groups/",data:{groups:c.groups.groupid}}).success(function(a){a.ErrorMessage?e(a):d(a.groups)}).error(function(a){e(a)}):e("groups or userid are missing")}function B(c,d,e){var f={q:c.q||"",page:c.page||1,lang:"en"};for(var g in c)"view"!==g&&"collection"!==g&&"undefined"!=typeof c[g]&&(f[g]=c[g]);a({url:b.restoServerUrl+"/api/collections"+(c.collection?"/"+c.collection:"")+"/search.json",method:"GET",params:f}).success(function(a){d(a)}).error(function(a){e(a)})}var C={activateUser:k,addGroups:A,addUser:i,createGroup:z,deleteGroups:w,deactivateUser:l,deleteRight:t,getCollections:d,getCollectionsStats:f,getHistory:c,getGroups:x,getGroupsRights:q,getGroupUsers:y,getRight:s,getSignatures:p,getUser:j,getUsers:g,getUsersStats:h,searchProducts:B,setAdvancedRight:v,setCollectionRight:e,setRight:u,setUserGroup:o,updateGroupRights:r,unvalidateUser:n,validateUser:m};return C}angular.module("administration").factory("administrationAPI",["$http","CONFIG",a])}(),function(){"use strict";function a(a,b){function c(c,d){a({method:"GET",url:b.restoServerUrl+"/collections"}).success(function(a){a.collections?c(a.collections):d()}).error(function(){d()})}function d(c,d,e){a({method:"GET",url:b.restoServerUrl+"/collections/"+c}).success(function(a){a?d(a):e()}).error(function(){e()})}function e(c,d,e){a({method:"GET",url:b.restoServerUrl+"/api/collections/"+c.collectionName+"/search.json",params:{page:c.page}}).success(function(a){a?d(a):e()}).error(function(){e()})}function f(c,d,e){a({method:"DELETE",url:b.restoServerUrl+"/collections/"+c}).success(function(){d()}).error(function(a){e(a.message)})}function g(c,d,e){c.collectionName&&c.featureIdentifier||e("missing attributes"),a({method:"DELETE",url:b.restoServerUrl+"/collections/"+c.collectionName+"/"+c.featureIdentifier}).success(function(){d()}).error(function(a){e(a)})}function h(){}function i(){}var j={getCollection:d,getCollections:c,getItems:e,deleteCollection:f,deleteItem:g,postCollection:h,postItem:i};return j}angular.module("administration").factory("restoCollectionsAPI",["$http","CONFIG",a])}(),function(){"use strict";function a(a,b){function c(c,d){a({method:"GET",url:b.restoServerUrl+"/api/user/connect"}).success(function(a){a.token?c(a.token):d()}).error(function(){d()})}function d(c,d,e){a({method:"GET",url:b.restoServerUrl+"/users/"+c.userid+"/signatures/"+c.collection,dataType:"json",contentType:"application/json"}).success(function(a){a.ErrorMessage?alert("internal error : "+a.ErrorMessage):a.signatures[c.collection]===!1?d():e("unsigned")}).error(function(a){alert("internal error : "+a.ErrorMessage)})}function e(c,d,e){return c.userid&&c.collection?void a({method:"POST",url:b.restoServerUrl+"/api/users/"+c.userid+"/signLicense",dataType:"json",data:{collection:c.collection},contentType:"application/json"}).success(function(a){a.ErrorMessage?e(a):d()}).error(function(a){e(a.ErrorMessage?a.ErrorMessage:a)}):(alert("internal error - signLicense"),!1)}function f(c,d,e){a({method:"GET",url:b.restoServerUrl+"/users/"+c.userid+"/orders/"+c.orderid+".meta4",dataType:"json",contentType:"application/json"}).success(function(a){a.ErrorMessage?e(a):d(a)}).error(function(a){e(a.ErrorMessage?a.ErrorMessage:a)})}function g(c,d,e){a({method:"POST",url:b.restoServerUrl+"/users/"+c.userid+"/orders",dataType:"json",data:c.features,contentType:"application/json"}).success(function(a){d(a)}).error(function(){e()})}function h(c,d,e){a({method:"GET",url:b.restoServerUrl+"/users/"+c.userid+"/orders"}).success(function(a){d(a.orders)}).error(function(a){e(a)})}function i(c,d,e){a({method:"POST",url:b.restoServerUrl+"/users",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:{email:c.email,password:c.password,username:c.username,givename:c.givename,lastname:c.lastname}}).success(function(a){a.ErrorMessage?e(a):d(a)}).error(function(){alert("error - user creation")})}var j={checkLicense:d,connect:c,getOrder:f,getOrders:h,postOrder:g,signLicense:e,signup:i};return j}angular.module("administration").factory("restoUsersAPI",["$http","CONFIG",a])}(),function(){"use strict";function a(a,b){function c(c,d,e){var f=b.restoServerUrl+b.statistics.statsEndpoint;f=f+"/users/count/"+c,a.get(f).success(function(a){a.ErrorMessage?e(a):d(a.counts)}).error(function(a){e(a&&a.ErrorMessage?a:"error - get users count")})}function d(c,d,e){var f=b.restoServerUrl+b.statistics.statsEndpoint;f+="/users/downloads/count/";var g=!0;for(var h in c)g?(f=f+"?"+h+"="+c[h],g=!1):f=f+"&"+h+"="+c[h];a.get(f).success(function(a){a.ErrorMessage?e(a):d(a.downloads)}).error(function(a){e(a&&a.ErrorMessage?a:"error - get users count")})}function e(c,d,e,f){var g=b.restoServerUrl+b.statistics.statsEndpoint;g=g+"/"+c;var h=!0;for(var i in d)h?(g=g+"?"+i+"="+d[i],h=!1):g=g+"&"+i+"="+d[i];a.get(g).success(function(a){a.ErrorMessage?f(a):e(a[c])}).error(function(a){f(a&&a.ErrorMessage?a:"error - get users count")})}function f(c,d,e,f){var g=b.restoServerUrl+b.statistics.statsEndpoint;g=g+"/"+c+"/recent";var h=!0;for(var i in d)h?(g=g+"?"+i+"="+d[i],h=!1):g=g+"&"+i+"="+d[i];a.get(g).success(function(a){a.ErrorMessage?f(a):e(a[c])}).error(function(a){f(a&&a.ErrorMessage?a:"error - get users count")})}function g(c,d,e,f){var g=b.restoServerUrl+b.statistics.statsEndpoint;g=g+"/"+c+"/best";var h=!0;for(var i in d)h?(g=g+"?"+i+"="+d[i],h=!1):g=g+"&"+i+"="+d[i];a.get(g).success(function(a){a.ErrorMessage?f(a):e(a[c])}).error(function(a){f(a&&a.ErrorMessage?a:"error - get users count")})}function h(c,d,e,f){var g=b.restoServerUrl+b.statistics.statsEndpoint;g=g+"/"+c+"/products";var h=!0;for(var i in d)h?(g=g+"?"+i+"="+d[i],h=!1):g=g+"&"+i+"="+d[i];a.get(g).success(function(a){a.ErrorMessage?f(a):e(a[c])}).error(function(a){f(a&&a.ErrorMessage?a:"error - get users count")})}function i(c,d){var e=b.restoServerUrl+b.statistics.statsEndpoint;e+="/users/countries/geometry",a.get(e).success(function(a){a.ErrorMessage?d(a):c(a)}).error(function(a){d(a&&a.ErrorMessage?a:"error - get users count")})}var j={getCount:c,getDownloadsCountsByUser:d,getLogsCountsByMonth:e,getLogsCountsByProduct:g,getLogsCountsByProductByMonth:h,getLogsCountsByRecentMonth:f,getUsersWorldGeometry:i};return j}angular.module("administration").factory("statsAPI",["$http","CONFIG",a])}(),function(){"use strict";function a(a,b,c,d,e,f){d.isUserAnAdministrator()&&(a.restoServerUrl=f.restoServerUrl,a.getCollection=function(b){e.getCollection(b,function(b){a.collection=b,a.ready=!0},function(a){alert(c("translate")("error.getCollections"))})},a.getItems=function(d){var f=[];f.collectionName=b.collectionname,f.page=a.page,e.getItems(f,function(b){a.page=a.page+1,d===!1?a.features=b.features:a.features=a.features.concat(b.features),0===b.properties.totalResults&&(a.page=a.page-1)},function(){alert(c("translate")("error.getItems"))})},a.deleteFeature=function(d){var f=confirm(c("translate")("Delete feature ?"));if(f){var g=[];g.collectionName=b.collectionname,g.featureIdentifier=d,e.deleteItem(g,function(){a.page=1,a.getItems(!1)},function(a){alert(c("translate")("error.deleteFeature")+a.ErrorMessage)})}},a.loadMore=function(){a.getItems(!0)},a.init=function(){a.ready=!1,a.features=[],a.busy=!0,a.page=1,a.getCollection(b.collectionname),a.getItems(!1),a.$emit("showCollection")},a.init())}angular.module("administration").controller("CollectionController",["$scope","$routeParams","$filter","administrationServices","restoCollectionsAPI","CONFIG",a])}(),function(){"use strict";function a(a,b,c,d){c.isUserAnAdministrator()&&(a.getCollections=function(){d.getCollections(function(b){a.collections=b},function(a){alert($filter("translate")("error.getCollections"))})},a.selectCollection=function(c){a.init(),b.path(b.path()+"/"+c)},a.init=function(){a.busy=!0,a.getCollections(),a.$emit("showCollections")},a.init())}angular.module("administration").controller("CollectionsController",["$scope","$location","administrationServices","restoCollectionsAPI",a])}(),function(){"use strict";function a(a,b,c,d,e,f){d.isUserAnAdministrator()&&(a.getGroupsRights=function(){e.getGroupsRights(a.groupid,function(b){a.rights=b.rights},function(a){alert(c("translate")("error.getGroupsRights"),a)})},a.getUsers=function(b){b||a.initCounter();var c=[];c.limit=a.limit,c.offset=a.offset,a.keyword&&""!==a.keyword&&(c.keyword=a.keyword),e.getGroupUsers({groupid:a.groupid,limit:a.limit,offset:a.offset},function(c){c.ErrorMessage?alert("error - "+c.ErrorMessage):(b?a.users=a.users.concat(c):a.users=c,a.offset=a.offset+a.limit,c[0]||(a.offset=a.offset-a.limit))},function(){alert("error : cannot get users")})},a.loadMoreUsers=function(){a.getUsers(!0)},a.removeFromGroup=function(b){var d=[];d.groups=a.groupid,d.userid=b,e.deleteGroups(d,function(b){a.getUsers()},function(a){alert(c("translate")("error.deleteGroups"),a)})},a.updateRight=function(b,d,f){var g=[];f=0===f?1:0,g[d]=f,g.collection_name=b,g.groupid=a.groupid,e.updateGroupRights(g,function(b){a.rights=b.rights},function(a){alert(c("translate")("error.updateRight"),a)})},a.init=function(){a.$emit("showGroup"),a.groupid=b.groupid,a.getGroupsRights(),a.getUsers(),a.initCounter()},a.initCounter=function(){a.offset=0,a.limit=f.limit},a.init())}angular.module("administration").controller("GroupController",["$scope","$routeParams","$filter","administrationServices","administrationAPI","CONFIG",a])}(),function(){"use strict";function a(a,b,c,d,e,f){c.isUserAnAdministrator()&&(a.getGroups=function(){var c=[];e.getGroups(c,function(b){a.groups=b},function(c){a.alert(b("translate")("error.getGroups"),c)})},a.selectGroup=function(b){a.init(),d.path(d.path()+"/"+b.groupid)},a.createGroup=function(c){e.createGroup(c,function(b){a.groups=b},function(c){a.alert(b("translate")("error.createGroups"),c)})},a.$emit("showGroups"),a.getGroups())}angular.module("administration").controller("GroupsController",["$scope","$filter","administrationServices","$location","administrationAPI","CONFIG",a])}(),function(){"use strict";function a(a,b,c,d){if(b.isUserAnAdministrator()){var e=[""];a.methods=e.concat(d.filters.methods),a.services=e.concat(d.filters.services),a.collections=[],a.setHistory=function(b){a.offset=0,a.limit=d.limit,a.showHistory=!1,"DESC"===a.ascOrDesc?a.ascOrDesc="ASC":a.ascOrDesc="DESC",a.orderBy=b,a.getHistory(!1)},a.getHistory=function(b){var d=[];d.limit=a.limit,d.offset=a.offset,d.ascordesc=a.ascOrDesc,d.orderby=a.orderBy,d.collection=a.collection,d.method=a.method,d.service=a.service,d.maxdate=a.maxdate,d.mindate=a.mindate,c.getHistory(d,function(c){a.offset=a.offset+a.limit,b===!1?a.history=c:a.history=a.history.concat(c),a.showHistory=!0,c[0]||(a.offset=a.offset-a.limit)},function(){alert($filter("translate")("error.getHistory"))})},a.loadMore=function(){a.getHistory(!0)},a.getCollections=function(){c.getCollections(function(b){a.collections.push("");for(var c in b)a.collections.push(b[c].name)},function(){alert($filter("translate")("error.setCollections"))})},a.setParam=function(b,c){a.init(),"method"===b?a.method=c:"service"===b?a.service=c:"collection"===b?a.collection=c:"mindate"===b?a.mindate=c:"maxdate"===b&&(a.maxdate=c),a.getHistory(!1)},a.resetFilters=function(){a.init(),a.initFilters(),a.getHistory(!1)},a.init=function(){a.ascOrDesc="DESC",a.orderBy=null,a.history=[],a.offset=0,a.limit=d.limit,a.showHistory=!1},a.initFilters=function(){a.selectedService=null,a.selectedCollection=null,a.selectedMethod=null,a.method=null,a.service=null,a.collection=null},a.init(),a.getHistory(),a.getCollections(),a.$emit("showHistory")}}angular.module("administration").controller("HistoryController",["$scope","administrationServices","administrationAPI","CONFIG",a])}(),function(){"use strict";function a(a,b,c,d){c.isUserAnAdministrator()&&(a.init=function(){a.$emit("showHome")},a.init())}angular.module("administration").controller("HomeController",["$scope","$filter","administrationServices","administrationAPI",a])}(),function(){"use strict";function a(a){function b(){return a.isAuthenticated()&&a.getPayload().data.groups.indexOf("admin")>-1?!0:!1}function c(){return a.getToken()}function d(a){var b=$("#hiddenDownloader");return a=a+(-1===a.indexOf("?")?"?":"&")+"_bearer="+c(),0===b.length&&(b=$('<iframe id="hiddenDownloader" style="display:none;">').appendTo("body")),b.attr("src",a).load(function(a){var b=JSON.parse($("body",$(this).contents()).text());if(b&&b.ErrorCode)switch(b.ErrorCode){case 3002:error("ERROR");break;case 403:error("Forbidden");break;case 404:error("Not found");break;default:error("Problem downloading")}}),!1}var e={getToken:c,isUserAnAdministrator:b,download:d};return e}angular.module("administration").factory("administrationServices",["$auth",a])}(),function(){"use strict";var a=angular.module("services",[]);a.factory("userActivation",["$http","CONFIG",function(a,b){return{get:function(c,d){a({method:"POST",url:b.activationURL,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(a){var b=[];for(var c in a)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")},data:{emailorgroup:"default",collection:collection,field:right,value:value}}).success(function(a){a.ErrorMessage?d(a):c(a)}).error(function(){d("error - user activation")})}}}]),a.factory("_RIGHTS",["$http","CONFIG",function(a,b){return{}}])}(),function(a){"use strict";function b(b,c,d,e,f,g,h){!function(i){if(c.isUserAnAdministrator()){b.error=[],b.stats=[],b.chart=[],b.maps=[],b.showMapUsers=!0,b.feat=[],b.products=[],b.downloadableLinks=[],b.params={},b.restoServerUrl=f.restoServerUrl;var j=["#E6E6E6","#D8D8D8","#BDBDBD","#A4A4A4","#848484","#6E6E6E","#585858","#424242","#2E2E2E","#000000"];b.initMap=function(c,g){var h=new a.ol.style.Style({fill:new a.ol.style.Fill({color:"#fff"}),stroke:new a.ol.style.Stroke({color:"#319FD3",width:.5}),text:new a.ol.style.Text({font:"12px Calibri,sans-serif",fill:new a.ol.style.Fill({color:"#000"}),stroke:new a.ol.style.Stroke({color:"#fff",width:3})})}),i=[h],k=new a.ol.layer.Vector({source:new a.ol.source.Vector({url:"data/countries.geojson",format:new a.ol.format.GeoJSON}),style:function(a,b){return i}}),l=new a.ol.style.Style({fill:new a.ol.style.Fill({color:"rgba(255, 255, 255, 0.6)"}),stroke:new a.ol.style.Stroke({color:"#319FD3",width:1}),text:new a.ol.style.Text({font:"12px Calibri,sans-serif",fill:new a.ol.style.Fill({color:"#000"}),stroke:new a.ol.style.Stroke({color:"#fff",width:3})})}),m=[l],n=new a.ol.layer.Heatmap({source:new a.ol.source.Vector({format:new a.ol.format.GeoJSON,url:f.restoServerUrl+"/"+f.statistics.statsEndpoint+"/users/countries/centroid"}),opacity:.9});n.getSource().on("addfeature",function(a){var b=parseFloat(a.feature.get("count"));a.feature.set("weight",b)});new a.ol.layer.Tile({source:new a.ol.source.Stamen({layer:"toner"})});e(function(){var e=new a.ol.Map({layers:[k],target:c,view:new a.ol.View({center:[0,0],zoom:1})});e.on("pointermove",function(a){if(!a.dragging){var c=e.getEventPixel(a.originalEvent),d=e.forEachFeatureAtPixel(c,function(a,b){return a});d&&b.feat.name!=d.get("name")&&b.$apply(function(){b.feat.count=parseFloat(d.get("count")?d.get("count"):0),b.feat.name=d.get("name"),b.feat.ranking=d.get("ranking")})}}),d.getUsersWorldGeometry(function(b){var c=new a.ol.layer.Vector({source:new a.ol.source.Vector({features:(new a.ol.format.GeoJSON).readFeatures(b,{featureProjection:"EPSG:3857"})}),style:function(a,b){return l.getText().setText(8e3>b?a.get("name"):""),l.getStroke().setColor(j[a.get("ranking")]),l.getFill().setColor(j[a.get("ranking")]),m}});e.addLayer(c)},function(){b.throwError("error.getGeometry")})},200)},b.getCount=function(a){d.getCount(a,function(c){b.stats[a]=c,b.chart[a]=[],b.chart[a].data=[],b.chart[a].labels=[];for(var d=0;d<c.length;d++)0!==c[d][1]&&c[d][0]&&(b.chart[a].data[d]=c[d][1],b.chart[a].labels[d]=c[d][0]);b.chart[a].data=[b.chart[a].data]},function(){b.throwError("error.getCount : "+a)})},b.getLogsCountsByMonth=function(a){d.getLogsCountsByRecentMonth(a,b.params,function(c){for(var d=[],e=[],f=[],g="nothing",h=0;h<c.length;h++){-1===d.indexOf(c[h].collection)&&d.push(c[h].collection);var i=d.indexOf(c[h].collection);g!==c[h].date&&(e.push(c[h].date),g=c[h].date);var j=e.indexOf(c[h].date);"undefined"==typeof f[i]&&(f[i]=[]);for(var k=0;j>=k;k++)k===j?f[i][j]=c[h].count:-1===f[i].indexOf(k)&&f[i].push(0)}b.chart[a]=[],b.chart[a].series=d.length>0?d:[""],b.chart[a].labels=e.length>0?e:[""],b.chart[a].values=f.length>0?f:[""]},function(){b.throwError("error.getCountByMonth : "+a)})},b.getLogsBestCountsByProduct=function(a,c,e){b.params.collection&&(e.collection=b.params.collection),d.getLogsCountsByProduct(c,e,function(c){b.products.best[a]=c},function(){b.throwError("error.getCountByProduct : "+a)})},b.getDownloadsCountsByUser=function(a,c){b.params.collection&&(c.collection=b.params.collection),d.getDownloadsCountsByUser(c,function(c){b.products.best[a]=c},function(){b.throwError("error.getCounByUser : "+a)})},b.initDensityMap=function(c,d){var f=new a.ol.layer.Vector({source:new a.ol.source.Vector({url:"data/countries.geojson",format:new a.ol.format.GeoJSON}),style:new a.ol.style.Style({fill:new a.ol.style.Fill({color:"#fff"}),stroke:new a.ol.style.Stroke({color:"#319FD3",width:.5}),text:new a.ol.style.Text({font:"12px Calibri,sans-serif",fill:new a.ol.style.Fill({color:"#000"}),stroke:new a.ol.style.Stroke({color:"#fff",width:3})})})}),g=new a.ol.style.Style({fill:new a.ol.style.Fill({color:"rgba(255, 255, 255, 0.6)"}),stroke:new a.ol.style.Stroke({color:"#319FD3",width:1}),text:new a.ol.style.Text({font:"12px Calibri,sans-serif",fill:new a.ol.style.Fill({color:"#000"}),stroke:new a.ol.style.Stroke({color:"#fff",width:3})})}),h=[g];e(function(){var e=new a.ol.Map({layers:[f],target:c,view:new a.ol.View({center:[0,0],zoom:1})});e.on("pointermove",function(a){if(!a.dragging){var c=e.getEventPixel(a.originalEvent),d=e.forEachFeatureAtPixel(c,function(a,b){return a});d&&b.feat.name!=d.get("name")&&b.$apply(function(){b.feat.count=parseFloat(d.get("count")?d.get("count"):0),b.feat.name=d.get("name"),b.feat.ranking=d.get("ranking")})}}),d&&d(function(b){var c=new a.ol.layer.Vector({source:new a.ol.source.Vector({features:(new a.ol.format.GeoJSON).readFeatures(b,{featureProjection:"EPSG:3857"})}),style:function(a,b){return g.getText().setText(8e3>b?a.get("name"):""),g.getStroke().setColor(j[a.get("ranking")]),g.getFill().setColor(j[a.get("ranking")]),h}});e.addLayer(c)},function(){b.showMapUsers=!1,b.throwError("cannot get information about users countries")}),b.maps[c]=e},200)},b.download=function(a){c.download(a)},b.initDownloadLinks=function(){var a="",c=!0;for(var d in b.params)c?(a=a+"?"+d+"="+b.params[d],c=!1):a=a+"&"+b.params.key+"="+b.params.value;b.downloadableLinks={downloads:f.restoServerUrl+f.statistics.statsEndpoint+"/downloads.csv"+a,search:f.restoServerUrl+f.statistics.statsEndpoint+"/search.csv"+a,insert:f.restoServerUrl+f.statistics.statsEndpoint+"/insert.csv"+a}},b.setParam=function(a,c){"collection"===a&&(b.params.collection=c),b.initStatsAndCharts()},b.throwError=function(a){var b="<strong>Error : </strong>"+a;h.create("danger",b)},b.init=function(){b.showMapUsers=!0,f.statistics.displayMapDensity&&b.initDensityMap("mapUsers",d.getUsersWorldGeometry),g.getCollections(function(a){b.collections=a,b.collections.unshift({name:""})},function(){b.collections=null}),b.initStatsAndCharts()},b.initStatsAndCharts=function(){
b.stats=[],b.chart=[],b.products=[],b.products.best=[],b.getCount("country"),b.getCount("organizationcountry"),b.getCount("topics"),b.getLogsCountsByMonth("downloads"),b.getLogsCountsByMonth("search"),b.getLogsCountsByMonth("insert"),b.getLogsBestCountsByProduct("downloads_all_time","downloads",{_limit:10}),b.getDownloadsCountsByUser("downloaders_all_time",{_limit:10}),b.initDownloadLinks()},b.$emit("showStats"),b.init()}}(a.ol)}angular.module("administration").controller("StatsController",["$scope","administrationServices","statsAPI","$timeout","CONFIG","restoCollectionsAPI","Flash",b])}(window),function(){"use strict";function a(a,b,c,d,e,f,g){if(c.isUserAnAdministrator()){var h=[""];a.methods=h.concat(g.filters.methods),a.services=h.concat(g.filters.services),a.collections=[],a.templates={history:"app/html/user/templates/history.html",rights:"app/html/user/templates/rights.html",rightCreation:"app/html/user/templates/rightCreation.html",signatures:"app/html/user/templates/signatures.html",groups:"app/html/user/templates/groups.html"},a.init=function(){a.showRights=!1,a.showHistory=!1,a.showCreation=!1,a.showSignatures=!1,a.showGroups=!1,a.history=[],a.feature=[],a.feature.collection=null,a.feature.search=!1,a.feature.visualize=!1,a.feature.download=!1,a.feature.canput=!1,a.feature.canpost=!1,a.feature.candelete=!1,a.feature.filters=null,a.ascOrDesc="DESC",a.orderBy=null,a.offset=0,a.limit=g.limit,a.template=null},a.initFilters=function(){a.ascOrDesc="DESC",a.orderBy=null,a.offset=0,a.limit=g.limit},a.activation=function(){1===a.selectedUser.activated?f.deactivateUser(a.selectedUser.userid,function(){a.initUser(function(){a.getRights()})},function(){a.alert(b("translate")("error.activation"))}):0===a.selectedUser.activated?f.activateUser(a.selectedUser.userid,function(){a.initUser(function(){a.getRights()})},function(){a.alert(b("translate")("error.activation"))}):a.alert(b("translate")("error.activation"))},a.validation=function(){null!==a.selectedUser.validationdate?f.unvalidateUser(a.selectedUser.userid,function(){a.initUser(function(){a.getRights()})},function(){a.alert(b("translate")("error.validation"))}):f.validateUser(a.selectedUser.userid,function(){a.initUser(function(){a.getRights()})},function(){a.alert(b("translate")("error.validation"))})},a.changeGroup=function(){"default"===a.selectedUser.groupname?a.setGroup("admin"):"admin"===a.selectedUser.groupname&&a.setGroup("default")},a.setRight=function(c,d,e){if(1===e[d])e[d]=0;else{if(0!==e[d])return void a.alert(b("translate")("error.setRight"));e[d]=1}var g=[];g.userid=a.selectedUser.userid,g.collection=c,g.rights=e,f.setRight(g,function(){a.getRights()},function(b){a.alert("Error : cannot set right",b)})},a.setGroup=function(b){var c=[];c.userid=a.selectedUser.userid,c.email=a.selectedUser.email,c.groupname=b,f.setUserGroup(c,function(){a.initUser(function(){a.getRights()})})},a.displayHistory=function(){a.init(),a.initFilters(),a.getHistory(),a.template=a.templates.history,a.showHistory=!0},a.displayRights=function(){a.init(),a.getRights(),a.getSignatures(),a.template=a.templates.rights,a.showRights=!0},a.displaySignatures=function(){a.init(),a.getSignatures(),a.template=a.templates.signatures,a.showSignatures=!0},a.displayGroups=function(){a.newGroup=null,a.init(),a.getGroups(),a.listGroups(),a.template=a.templates.groups,a.newGroup="",a.showGroups=!0},a.goToHistory=function(){var b="/users/"+a.selectedUser.userid+"/history";d.path(b,!1),a.displayHistory()},a.goToRights=function(){var b="/users/"+a.selectedUser.userid;d.path(b,!1),a.displayRights()},a.goToSignatures=function(){var b="/users/"+a.selectedUser.userid+"/signatures";d.path(b,!1),a.displaySignatures()},a.goToGroups=function(){var b="/users/"+e.userid+"/groups";d.path(b,!1),a.displayGroups()},a.goToAdvancedRights=function(){var b="/users/"+a.selectedUser.userid+"/rights";d.path(b,!1),a.displayCreateAdvancedRights()},a.setCollection=function(b){a.feature.collection=b},a.displayCreateAdvancedRights=function(){a.init(),a.template=a.templates.rightCreation,a.showCreation=!0},a.deleteAdvancedRight=function(b,c){var d=confirm("Delete right ?");d&&a.deleteAdvancedRightConfirmed(b,c)},a.deleteAdvancedRightConfirmed=function(b,c){var d=[];d.collection=b,d.featureid=c,d.userid=a.selectedUser.userid,d.email=a.selectedUser.email,f.deleteRight(d,function(){a.getRights()})},a.deleteRightsConfirmed=function(c){var d=[];d.collection=c,d.userid=a.selectedUser.userid,d.email=a.selectedUser.email,f.deleteRight(d,function(){a.getRights()},function(c){a.alert(b("translate")("error.deleteRight"),c)})},a.deleteRights=function(b){var c=confirm("Reset rights ?");c&&a.deleteRightsConfirmed(b)},a.initUser=function(b){f.getUser(e.userid,function(c){a.selectedUser=c,b()})},a.getRights=function(){f.getRight(e.userid,function(b){a.rights=b})},a.getSignatures=function(){f.getSignatures(e.userid,function(b){a.signatures=b})},a.setHistory=function(b){a.limit=g.limit,a.offset=0,"DESC"===a.ascOrDesc?a.ascOrDesc="ASC":a.ascOrDesc="DESC",a.orderBy=b,a.getHistory(!1)},a.getHistory=function(b){var c=[];c.limit=a.limit,c.offset=a.offset,c.ascordesc=a.ascOrDesc,c.orderby=a.orderBy,c.userid=e.userid,c.collection=a.selectedCollection,c.method=a.selectedMethod,c.service=a.selectedService,c.email=a.selectedUser.email,f.getHistory(c,function(c){a.offset=a.offset+a.limit,b===!1?a.history=c:a.history=a.history.concat(c),c[0]||(a.offset=a.offset-a.limit)},function(b){a.alert("Error cannot get history",b)})},a.setParam=function(b,c){a.initFilters(),"method"===b?a.selectedMethod=c:"service"===b?a.selectedService=c:"collection"===b&&(a.selectedCollection=c),a.getHistory(!1)},a.resetFilters=function(){a.selectedService=null,a.selectedCollection=null,a.selectedMethod=null,a.collection=null,a.initFilters(),a.getHistory(!1)},a.loadMore=function(){a.getHistory(!0)},a.getCollections=function(){f.getCollections(function(b){a.collections.push("");for(var c in b)a.collections.push(b[c].name)},function(){alert(b("translate")("error.setCollections"))})},a.getGroups=function(){var c=[];c.userid=e.userid,f.getGroups(c,function(b){a.groups=a.formatGroups(b)},function(c){a.alert(b("translate")("error.getGroups"),c)})},a.listGroups=function(){f.getGroups([],function(b){a.groupsList=b},function(c){a.alert(b("translate")("error.getGroups"),c)})},a.addGroups=function(c){var d=[];d.groups=c,d.userid=e.userid,f.addGroups(d,function(b){a.groups=a.formatGroups(b)},function(c){a.alert(b("translate")("error.addGroups"),c)})},a.deleteGroup=function(c){var d=[];d.groups=c,d.userid=e.userid,f.deleteGroups(d,function(b){a.groups=a.formatGroups(b)},function(c){a.alert(b("translate")("error.deleteGroups"),c)})},a.formatGroups=function(a){return a&&""!==a?a.split(","):null},a.alert=function(a,b){var c=a+("undefined"==typeof b?"":" - details : "+(b.ErrorMessage?b.ErrorMessage:b));alert(c)},a.$emit("showUser"),a.init(),a.initUser(function(){a.displayRights(),a.getCollections(),"history"===e.section?a.displayHistory():"signatures"===e.section?a.displaySignatures():"rights"===e.section?a.displayCreateAdvancedRights():"groups"===e.section&&a.displayGroups()})}}angular.module("administration").controller("UserController",["$scope","$filter","administrationServices","$location","$routeParams","administrationAPI","CONFIG",a])}(),function(){"use strict";function a(a,b,c,d){c.isUserAnAdministrator()&&(a.profile=[],a.createUser=function(){if(void 0===a.profile.email||void 0===a.profile.password)return void alert(b("translate")("user.please set email and password"));var c=[];c.email=a.profile.email,c.password=a.profile.password,c.username=a.profile.username,c.givename=a.profile.givename,c.lastname=a.profile.lastname,d.addUser(c,function(){alert(b("translate")("user.user created")),a.profile=[]},function(a){alert(b("translate")("user.error")+a.ErrorMessage)}),a.profile.email=null,a.profile.password=null,a.profile.username=null,a.profile.givename=null,a.profile.lastname=null})}angular.module("administration").controller("UserCreationController",["$scope","$filter","administrationServices","administrationAPI","CONFIG",a])}(),function(){"use strict";function a(a,b,c,d,e,f){d.isUserAnAdministrator()&&(a.getUsers=function(b){b||a.initCounter();var d=[];d.limit=a.limit,d.offset=a.offset,a.keyword&&""!==a.keyword&&(d.keyword=a.keyword),e.getUsers(d,function(c){c.ErrorMessage?alert("error - "+c.ErrorMessage):(b?a.users=a.users.concat(c):a.users=c,a.offset=a.offset+a.limit,a.showUsers=!0,c[0]||(a.offset=a.offset-a.limit))},function(){alert(c("translate")("error.cannot_get_users"))})},a.selectUser=function(c){a.init(),a.selectedUser=c,b.path(b.path()+"/"+c.userid)},a.loadMore=function(){a.getUsers(!0)},a.init=function(){a.users=[],a.showUsers=!1,a.selectedUser=null,a.keyword=null,a.initCounter(),a.$emit("showUsers")},a.initCounter=function(){a.offset=0,a.limit=f.limit},a.init(),a.getUsers(!1))}angular.module("administration").controller("UsersController",["$scope","$location","$filter","administrationServices","administrationAPI","CONFIG",a])}();